**서브쿼리**

- 서브쿼리(Subquery)란 하나의 SQL문 안에 포함되어 있는 또 다른 SQL문을 말한다. 즉, 서브쿼리가 메인쿼리에 포함되는 종속적인 관계이다
- 큰 개념의 조인에 포함시킬 수도 있으나, 보통은 조인과 구분한다
- 서브쿼리를 문법적으로 구분하는 가장 쉬운 방법은 SQL문이 괄호(~~)로 묶여져 있으면 서브쿼리이다
- 일반적으로 서브쿼리의 위치에 따라 다음과 같이 나눌 수 있다
  - WHERE절 : Nested Subquery(가장 먼저 개발됨)
  - FROM절 : Inline View(SQL 문장 내 절차성 효과)
  - SELECT절 : Scalar Subquery(가장 최근에 개발됨)
- Scalar Subquery 의 경우 함수적 특성을 가짐
- 서브쿼리는 메인쿼리의 칼럼을 모두 사용할 수 있지만 메인쿼리는 서브쿼리의 칼럼을 사용할 수 없다. (예외적으로 인라인뷰에 정의된 칼럼은 메인쿼리에서 사용 가능)

**서브쿼리와 조인**

- 조인과 서브쿼리를 논리적으로 구분하는 가장 좋은 방법은 두 개의 테이블 위치를 바꾸어 보는 것이다
- 조인은 두 개의 테이블 위치를 바꾸어 보더라도 같은 결과가 나오며, 서브쿼리의 경우는 주종의 관계이므로 일반적으로 다른 결과가 나오게 된다
- 만일 서브쿼리에서 두 개의 테이블 위치를 바꾸었는데도 같은 결과가 나온다면, 조인으로 바꿀 수 있다는 얘기가 되므로 일반적으로 서브쿼리를 집합적 개념을 사용할 수 있는 조인으로 바꾸는 것을 권고한다
- SQL문에서 서브쿼리 방식을 사용해야 할 때 잘못 판단하여 조인 방식을 사용하는 경우도 있다. 예를 들어, 부서(1) 레벨이고 사원(M) 테이블에서 체크해야 할 조건이 존재한다고 가정하자. 이런 상황에서 조인을 사용한다면 결과 집합은 사원(M) 레벨이 될 것이다. 이렇게 되면 원하는 결과를 만들기 위해 GROUP BY나 DISTINCT를 추가해서 결과를 다시 조직(1) 레벨로 만들어야 한다. 이와 같은 상황에서는 조인방식이 아니라 서브쿼리 방식을 사용해야 한다. 조인과는 달리 서브쿼리를 사용해야 되는 경우도 많으므로, 조인과 서브쿼리의 용도를 정확히 알고 작성해야 한다. 

**서브쿼리 종류**

- 서브쿼리의 종류는 반환되는 데이터의 형태에 따라 다음과 같이 분류할 수 있다
- ![스크린샷 2023-11-09 오후 10.58.25](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 10.58.25.png)

**단일행 서브쿼리**

- 서브쿼리가 단일행 비교 연산자(=, <, <=, >, >=, <>)와 함께 사용할 때는 서브쿼리의 결과 건수가 반드시 1건 이하이어야 한다. 만약, 서브쿼리의 결과 건수가 2건 이상을 반환하면 SQL문은 실행시간(Run Time)오류가 발생한다. 이런 종류의 오류는 컴파일 할 때(Compile Time)는 알 수 없는 오류이다. 
- ![스크린샷 2023-11-09 오후 11.00.22](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.00.22.png)
- 정남일 선수가 동명이인이 없다면 정상적인 수행이 되지만, 동명이인이 다른 팀에 있다면 두개 이상의 TEAM_ID가 반환되므로 런타임 오류가 발생한다
- 서브쿼리의 결과가 2건 이상 반환될 수 있다면 반드시 다중행 비교 연산자(IN, ALL, ANY, SOME)와 함께 사용해야 한다.

**다중행 비교연산자**

- ![스크린샷 2023-11-09 오후 11.02.38](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.02.38.png)

**다중행 서브쿼리**

- ![스크린샷 2023-11-09 오후 11.02.53](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.02.53.png)
- ![스크린샷 2023-11-09 오후 11.03.02](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.03.02.png)

**다중칼럼 서브쿼리**

- ![스크린샷 2023-11-09 오후 11.03.27](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.03.27.png)

**서브쿼리 종류**

- 서브쿼리의 종류는 동작하는 방식에 따라 다음과 같이 분류할 수 있다. 앞에서 설명한 네스티드 서브쿼리들은 비연관 서브쿼리의 예제들이었다.
- ![스크린샷 2023-11-09 오후 11.04.03](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.04.03.png)

**연관 서브쿼리**

- 연관 서브쿼리는 서브쿼리 내에 메인쿼리 칼럼이 사용된 서브쿼리이다.
- ![스크린샷 2023-11-09 오후 11.04.30](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.04.30.png)

**EXISTS 서브쿼리**

- EXISTS 서브쿼리는 항상 연관 서브쿼리로 사용된다
- EXISTS 서브쿼리의 특징은 아무리 조건을 만족하는 건이 여러 건이더라도 조건을 만족하는 1건만 찾으면 추가적인 검색을 진행하지 않는다
- 현업에서 조건을 만족하는지 여부를 묻는 로직이 많이 사용되는데, 성능에 부담이 적은 EXISTS 절을 우선적으로 검토할 필요가 높다
- EXISTS 연산자의 왼쪽에는 칼럼명이나 상수가 표시되지 않는다
- 서브쿼리의 데이터가 필요한 경우가 아니라면 1,'X' 같은 업무적으로 의미없는 상수값을 선택하는 것이 좋다
- ![스크린샷 2023-11-09 오후 11.06.04](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.06.04.png)

**연관 서브쿼리 업데이트**

- ![스크린샷 2023-11-09 오후 11.06.21](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.06.21.png)
- 그러나, STADIUM_NAME 칼럼에 기존 데이터가 있는 경우 위 연관 서브쿼리를 사용은 주의해야 한다. 변경 작업 수행시 연관 서브쿼리 조인 조건이 맞지 않는 경우 서브쿼리의 공집합 결과가 STADIUM_NAME 칼럼에 NULL 값으로 업데이트 될 수 있는 리스크가 있다
- NULL 업데이트 리스크를 해결하기 위해서는 EXISTS 조건을 통해 안정적으로 조인 조건만 맞는 데이터를 업데이트 하거나, 공집합을 NULL로 리턴하는 그룹함수 특성을 사용하는 방법을 적용한다.

**INLINE VIEW**

- FROM절에서 사용되는 서브쿼리를 인라인 뷰 라고 한다. FROM 절에는 테이블 명이 오도록 되어 있다. FROM절에 사용된 서브쿼리의 결과가 마치 실행 시에 동적으로 생성된 테이블인 것처럼 사용할 수 있다.
- 인라인 뷰는 SQL문이 실행될 때만 임시적으로 생성되는 동적인 뷰이기 때문에 데이터베이스에 해당 정보가 저장되지 않는다. 그래서 일반적인 뷰를 정적 뷰(Static View)라고 하고 인라인 뷰를 동적 뷰(Dynamic View)라고도 한다. 인라인 뷰는 테이블 명이 올 수 있는 곳에서 사용할 수 있다. 
- 중첩되어 사용할 수 있으며, 일반적으로 가장 안의 인라인 뷰부터 수행이 된다. (SQL 문장 내 절차적 프로그래밍 효과 가짐, 특별한 경우 뷰머지가 발생할수도 있음)
- ![스크린샷 2023-11-09 오후 11.09.48](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.09.48.png)
- 일반적으로 서브쿼리의 칼럼은 메인쿼리에서 사용할 수 없다. (반대는 상관 서브쿼리에서 가능함) 그러나, 인라인 뷰는 동적으로 생성된 테이블이기 때문에 인라인 뷰를 사용하는 것은 조인 방식을 사용하는 것과 같다. 결과적으로 인라인 뷰에서 정의된 카럼은 SQL문에 자유롭게 참조할 수 있다.
- ![스크린샷 2023-11-09 오후 11.32.17](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.32.17.png)
- 인라인 뷰의 중요 용도 중에 하나는 집합 간의 조인 회수를 줄이는 것이다. 조인 집합 간의 관계가 1:1이 아닌 1:M의 관계일 때 M쪽의 데이터를 인라인 뷰에서 먼저 GROUP BY 연산을 수행하여 통하여 메인쿼리의 집합과 1:1 조인을 수행할 수 있다. 
- ![스크린샷 2023-11-09 오후 11.33.08](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.33.08.png)

**VIEW**

- 테이블은 실제로 데이터를 가지고 있는 반면, 뷰는 실제 데이터를 가지고 있지 않다. 뷰는 단지 뷰 정의(View Definition, SQL 텍스트 파일) 만을 가지고 있다. 질의에서 뷰가 사용되면 뷰 정의를 참조해서 DBMS 내부적으로 질의를 재작성(Rewrite)하여 질의를 수행한다.
- Oracle의 경우 USER_VIEWS에서 해당 뷰에 사용된 SQL을 확인할 수 있다.
- 뷰는 실제 데이터를 가지고 있지 않지만 테이블이 수행하는 역할을 수행하기 때문에 가상 테이블이라고도 한다
- 뷰는 다음과 같이 CREATE VIEW 문을 통해서 생성할 수 있다
- ![스크린샷 2023-11-09 오후 11.35.01](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.35.01.png)
- ![스크린샷 2023-11-09 오후 11.35.13](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.35.13.png)
- 뷰를 사용하기 위해서는 해당 뷰의 이름을 테이블과 똑같이 이용하면 된다
- ![스크린샷 2023-11-09 오후 11.35.38](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.35.38.png)
- 뷰가 포함된 SQL을 파싱하는 시점에 DBMS가 내부적으로 SQL문을 다음과 같이 재작성한다.(View Merge)
- ![스크린샷 2023-11-09 오후 11.36.06](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.36.06.png)
- 뷰는 테이블 뿐만 아니라 이미 존재하는 뷰를 참조해서도 생성할 수 있다![스크린샷 2023-11-09 오후 11.36.29](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.36.29.png)
- 뷰를 제거하기 위해서는 DROP VIEW문을 사용한다![스크린샷 2023-11-09 오후 11.36.47](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.36.47.png)

**스칼라 서브쿼리**

- 스칼라 서브쿼리는 한 행, 한 칼럼만을 반환하는 서브쿼리를 말한다. 스칼라 서브쿼리는 칼럼을 쓸 수 있는 대부분의 곳에서 사용할 수 있다
- 스칼라 서브쿼리도 일종의 함수이므로 중첩해서 사용하고, OUTPUT이 두개 이상 나오는 경우나 OUTPUT의 데이터타입이 맞지 않는 경우 SYNTAX 에러가 발생합니다
- 스칼라 서브쿼리의 경우 FUNCTION(함수)의 특징을 가집니다. 함수는 기능적으로 많은 INPUT이 있더라도 OUTPUT은 일반적으로 하나만 나온다는 것과 성능면에서는 전체 데이터를 일일이 모든 건수만큼 수행해야 한다는 점입니다
- 대량의 데이터 처리시 스칼라 서브쿼리를 남발하는 경우는 조인의 장점이나 집합적 개념을 적용하기 힘드므로, 같은 결과를 얻을 수 있다면 가능하면 스칼라 서브쿼리가 아니라 조인으로 대체하는 것이 좋습니다

**스칼라 서브쿼리 위치**

- ![스크린샷 2023-11-09 오후 11.38.55](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.38.55.png)
- 만약 조회된 결과가 없다면, 즉 공집합이더라도 Select List의 값은 집계함수와 같이 NULL로 표시됩니다. 두 ROW이상의 결과가 출력되면 DBMS는 에러를 출력하게 됩니다

**스칼라 서브쿼리 위치**

- ![스크린샷 2023-11-09 오후 11.40.29](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.40.29.png)
- ![스크린샷 2023-11-09 오후 11.40.35](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.40.35.png)
- ![스크린샷 2023-11-09 오후 11.40.44](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.40.44.png)
- ![스크린샷 2023-11-09 오후 11.40.51](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.40.51.png)
- ![스크린샷 2023-11-09 오후 11.40.58](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.40.58.png)
- ![스크린샷 2023-11-09 오후 11.41.08](/Users/asthu/Library/Application Support/typora-user-images/스크린샷 2023-11-09 오후 11.41.08.png)

